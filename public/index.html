<!DOCTYPE html>
<html>
  <head>
    <title>Histogram</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js"></script>
    <style type="text/css">

      body {
        font: 10px sans-serif;
      }

      rect {
        fill: steelblue;
        stroke: white;
      }

      line {
        stroke: black;
        shape-rendering: crispEdges;
      }

 .chart div {
   font: 10px sans-serif;
   background-color: steelblue;
   text-align: right;
   padding: 3px;
   margin: 1px;
   color: white;
 }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      w = 30;
      h = 300;

      var year_min = 1000;
      var year_max = 2000;
      var year_size = 25;
      var domain_max = 0;
      var domain_min = 0;
      var data = [];

function initData() {
      domain_max = 0;
      domain_min = 0;
      data = [];
      for (var i = year_min; i <= year_max; i = i + year_size) {
        data.push( {"year": i, "count": 0 });
      }
}

   initData();

function mapData(data_input) {
   initData();
  for (var i= 0; i < data_input.length; ++i) {
    var input = data_input[i];
    for (var j= 0; j < data.length; ++j) {
      var input_date = parseInt(input.term);
      var range_date = parseInt(data[j].year);
      if ((input_date  < (range_date + year_size)) && (input_date >= range_date)) {
        data[j].count += input.count;
        if (data[j].count > domain_max) {
          domain_max = data[j].count;
        }
      }
    }
  }
  return data;
}

function initHist() {
  var data = mapData([]);
  var chart = d3.select("body").append("svg")
    .attr("class", "chart")
    .attr("width", w * data.length - 1)
    .attr("height", h + 30);
}

function updateHist(data_input) {
  console.log(data_input);
  var chart = d3.select("body").select("svg")
  var data = mapData(data_input);
  var x = d3.scale.linear()
    .domain([0, 1])
    .range([0, w]);

  var y = d3.scale.linear()
    .domain([0, domain_max])
    .rangeRound([0, h]);

 var hist = chart.selectAll("rect")
    .data(data);

    hist.enter().append("rect")
      .attr("x", function(d, i) { return x(i) - .5; })
      .attr("y", function(d) { return h - y(d.count) - .5; })
      .attr("width", w)
      .attr("height", function(d) { return y(d.count); });

 var texts = chart.selectAll(".label")
    .data(data);
    texts.enter().append('text')
      .attr("class", "label")
      .attr("x", function(d, i) { return x(i) - .5 + w / 2; })
      .attr("y", function(d) { return h - y(d.count) - .5 + 10; })
      .attr("width", w)
      .attr("text-anchor", "middle")
      .attr("height", function(d) { return y(d.count); })
      .text(function(d) { if (d.count > 0) { return d.count;} return ''; });

 var years = chart.selectAll(".year")
    .data(data);
    years.enter().append('text')
      .attr("class", "year")
      .attr("x", function(d, i) { return x(i) - .5 + w / 2; })
      .attr("y", function(d) { return h + 10; })
      .attr("width", w)
      .attr("text-anchor", "middle")
      .attr("height", function(d) { return 20; })
      .text(function(d) { return d.year; });
    
    hist.transition()
      .duration(500)
      .attr("y", function(d) { return h - y(d.count) - .5; })
      .attr("height", function(d) { return y(d.count); });

    texts.transition()
      .attr("y", function(d) { return h - y(d.count) - .5 + 10; })
      .attr("height", function(d) { return y(d.count); })
      .text(function(d) { if (d.count > 0) { return d.count;} return ''; });

    hist.exit()
        .remove();
    texts.exit()
      .remove();

}

  var load_data = function(search) {
    $.ajax({   url: '/es/artdb_staging/work/_search?pretty=true'
      , type: 'POST'
      //, data : '{ "query" : { "query_string" : {"query" : "picasso"} }}'
      //, data : '{ "query" : { "query_string" : {"query" : "picasso"} },     "facets" : { "tags" : { "terms" : {"field" : "creation.date"} } } }'
      , data : '{ "query" : { "query_string" : {"query" : "' + search + '"} },     "facets" : { "size": 10000, "tags" : { "terms" : {"field" : "creation_year", "size": 10000} } } }'
      , dataType : 'json'
      , processData: false
      , success: function(json, statusText, xhr) {
        return display_chart(json);
      }
      , error: function(xhr, message, error) {
        console.error("Error while loading data from ElasticSearch", message);
        throw(error);
      }
    });

    var display_chart = function(json) {
      //Donut().data(json.facets.tags.terms).draw();
      updateHist(json.facets.tags.terms);
    };

  };

  $( function() { 
    initHist();
    $('#search').keyup(function() {
      load_data($(this).val());
    });
    load_data($('#search').val());
  });

</script>
<form>
<input type="text" name="search" value="art" id="search" />
</form>
</body>
</html>

